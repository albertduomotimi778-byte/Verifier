<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifying Payment...</title>
    <style>
        body { 
            background-color: #020617; 
            color: white; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0;
            text-align: center; 
        }
        .container {
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            max-width: 400px;
            width: 90%;
        }
        .loader { 
            border: 4px solid #333; 
            border-top: 4px solid #6366f1; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { color: #f87171; font-weight: bold; }
        .success { color: #4ade80; font-weight: bold; margin-bottom: 0.5rem;}
        h2 { margin-top: 0; }
        p { color: #94a3b8; font-size: 0.9rem; margin-bottom: 0;}
    </style>
</head>
<body>
    <div class="container" id="status">
        <div class="loader"></div>
        <h2>Secure Verification</h2>
        <p>Connecting to SoulSync Secure Server...</p>
    </div>

    <script>
        // --- CONFIGURATION ---
        // This is where users are sent if they try to cheat (copy the link without paying)
        const SELAR_PAYMENT_URL = "https://selar.com/csf148s0v1"; 

        function verifyTransaction() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 1. CHECK FOR SELAR FINGERPRINTS
            // Selar appends these parameters after a successful purchase
            const txRef = urlParams.get('tx_ref') || urlParams.get('transaction_id');
            const status = urlParams.get('status'); // Selar often sends status=success

            // 2. SECURITY GUARD (The "Bouncer")
            // If the URL doesn't have a transaction ID, the user didn't come from Selar.
            // We kick them back to the payment page.
            if (!txRef && status !== 'success') {
                document.getElementById('status').innerHTML = `
                    <div style="font-size: 3rem;">ðŸš«</div>
                    <p class="error">Invalid Session Detected.</p>
                    <p>Redirecting to secure payment...</p>
                `;
                setTimeout(() => {
                    window.location.href = SELAR_PAYMENT_URL;
                }, 2000);
                return;
            }

            // 3. MINT THE LICENSE KEYS
            // We create the specific strings the App is looking for.
            const licenseString = txRef || `txn_${Date.now()}`;
            
            // This SALT (_soulsync_secure_887) matches the one in your App code.
            // If a user changes this, the App will reject the license.
            const validTag = btoa(licenseString + "_soulsync_secure_887"); 

            // 4. INJECT KEYS INTO BROWSER STORAGE
            // This allows the App (running in another tab/window) to read the keys.
            try {
                localStorage.setItem('soulsync_license_string', licenseString);
                localStorage.setItem('soulsync_license_tag', validTag);
                localStorage.setItem('soulsync_payment_signal', Date.now().toString());
            } catch (e) {
                console.error("Storage failed", e);
            }

            // 5. SEND MESSAGE TO APP (If opened via Popup)
            if (window.opener) {
                window.opener.postMessage('PAYMENT_VERIFIED', '*');
            }

            // 6. SHOW SUCCESS AND CLOSE
            document.getElementById('status').innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">âœ…</div>
                <h2 class="success">Payment Verified!</h2>
                <p>Premium features unlocked.</p>
                <p style="margin-top: 10px; font-size: 0.8rem; opacity: 0.7;">Closing window safely...</p>
            `;

            // Auto-close the popup after 3 seconds so the user is back in the App
            setTimeout(() => {
                if(window.opener) {
                    window.close();
                } else {
                    // If they are not in a popup (e.g. mobile redirect), tell them to go back
                    document.getElementById('status').innerHTML += `<p style="margin-top:20px"><a href="/" style="color:white">Return to App</a></p>`;
                }
            }, 3000);
        }

        // Run immediately
        verifyTransaction();
    </script>
</body>
</html>
